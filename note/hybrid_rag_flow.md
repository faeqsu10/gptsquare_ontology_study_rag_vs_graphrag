# Hybrid RAG: 벡터DB → 그래프DB 조합 방식 상세 설명

## 1. 전체 흐름 개요

1. **질문 입력**  
   사용자가 자연어로 질의를 입력

2. **벡터DB 1차 후보군 추출**  
   - 입력된 질문을 임베딩(embedding)하여, 벡터DB에 저장된 문서/문장/지식 조각과 유사도가 높은 top-k 후보를 빠르게 추출  
   - 이 단계는 “질문과 비슷한 의미의 내용”을 빠르고 폭넓게 골라내는 역할

3. **그래프DB 검증/확장**  
   - 벡터DB에서 추출된 후보(예: 관련 문서 ID, 엔티티, 문장 등)를 토대로  
   - 그래프DB에서 이 후보들과 연결된 추가 정보, 관계, 온톨로지 기반 확장 정보를 Cypher 쿼리 등으로 조회  
   - 예를 들어, 후보 문서의 연관 엔티티, 상위/하위 개념, 관련된 사건, 추가 속성 등  
   - 필요시, 후보의 정합성(정확/권위/최신 등)도 그래프DB의 관계/속성을 통해 검증

4. **최종 답변 생성**  
   - LLM(예: GPT)이 벡터DB+그래프DB에서 수집한 풍부한 context를 바탕으로 최종 답변 생성

---

## 2. 예시 시나리오

#### 예시: “최근 6개월간 평점이 높은 고객이 자주 주문한 메뉴는?”

1. **사용자 질의**  
   “최근 6개월간 평점이 높은 고객이 자주 주문한 메뉴는?”

2. **벡터DB 검색**  
   - “평점”, “고객”, “주문”, “메뉴”, “최근 6개월”과 유사한 문장/문서/리뷰 top-k 추출  
   - 예: “고객 A가 2024년 8월에 남긴 리뷰”, “평점 5점의 고객 주문 내역” 등

3. **그래프DB 확장/검증**  
   - 벡터DB 후보(고객/리뷰/주문/메뉴 ID 등)를 받아  
   - 그래프DB에서  
     - 해당 고객의 실제 평점이 4점 이상인지 검증  
     - 그들의 최근 6개월간 주문 이력을 관계(예: Customer—[:MADE_PURCHASE]→Purchase—[:FOR_MENU_ITEM]→MenuItem)로 추적  
     - 자주 주문한 메뉴를 집계(통계/집합)  
   - 추가로, 메뉴 간의 카테고리 관계, 계절성, 고객의 지역 등도 확장 탐색 가능

4. **최종 LLM 답변**  
   - 위에서 얻은 구조적/비정형 정보를 LLM에 context로 입력  
   - “최근 6개월간 평점 4점 이상의 고객들이 주로 주문한 메뉴는 스테이크, 파스타입니다. 특히 스테이크는 8월에 주문량이 급증했습니다.”처럼 종합 답변 출력

---

## 3. Hybrid 방식의 장점

- **속도**: 벡터DB에서 빠르게 후보군을 선정
- **정확성/신뢰성**: 그래프DB에서 관계 기반으로 추가 검증 및 정보 확장
- **복합 질의 대응**: 단순 유사도 검색+구조적 관계 탐색 결합

---

## 4. 데이터 흐름 그림(마인드맵 형태)

```
[질문입력]
     |
[임베딩 생성]
     |
[벡터DB 유사도 검색] ──(후보 문서/엔티티/ID 리스트)──▶ [그래프DB]
                                                |
                            [관계 기반 추가 탐색 및 검증]
                                                |
                                [LLM Context로 통합]
                                                |
                                    [최종 답변 생성]
```